% Bindi, D., Pacor, F., Luzi, L., Puglia, R., Massa, M., Ameri, G., & Paolucci, R. (2011).
% Ground motion prediction equations derived from the Italian strong motion database.
% Bulletin of Earthquake Engineering, 9(6), 1899-1920.

% Mw: Moment Magnitud
% Media: EC8 site classes. It can be: AEC8, BEC8, CEC8, DEC8 or EEC8
% Mechanism: Style of faulting. It  can be: 'normal', 'reverse', 'strike-slip' or 'unknown'
% Rrup: Fault distance [km] (Joyner-Boore distance)
% SA: It can be 'Geoh' or 'Z' it depends on which SA we want.

function [lny,sigma,tau,phi]=Bindi2011(To,Mw,Rjb,media,mechanism,component)

lny     = nan(size(M));
sigma   = nan(size(M));
phi     = nan(size(M));
tau     = nan(size(M));

if  and(To<0 || To> 2,To~=-1)
    return
end

if To>=0
    To      = max(To,0.01); %PGA is associated to To=0.01;
end

period  = [-1 0.01 0.04 0.07 0.1 0.15 0.2 0.25 0.3 0.35 0.4 0.45 0.5 0.6 0.7 0.8 0.9 1 1.25 1.5 1.75 2];
T_lo    = max(period(period<=To));              % Identify the period that is below for the later interpolation
T_hi    = min(period(period>=To));              % Identify the period that is above for the later interpolation
index   = find(abs((period - T_lo)) < 1e-6);    % Identify the period from the ones evaluated in the paper

if T_lo==T_hi
    [log10y,sigma,phi,tau] = gmpe(index,Mw,Rjb,media,mechanism,component);
else
    [log10y_lo,~,phi_lo,tau_lo] = gmpe(index,Mw,Rjb,media,mechanism,component);
    [log10y_hi,~,phi_hi,tau_hi] = gmpe(index+1,Mw,Rjb,media,mechanism,component);
    x       = log([T_lo;T_hi]);
    Y_sa    = [log10y_lo,log10y_hi]';
    Y_phi   = [phi_lo,phi_hi]';
    Y_tau   = [tau_lo,tau_hi]';
    log10y  = interp1(x,Y_sa,log(To))';
    phi     = interp1(x,Y_phi,log(To))';
    tau     = interp1(x,Y_tau,log(To))';
    sigma   = sqrt(phi.^2-tau.^2);
end

% log base conversio
lny   = log10y * log(10);
sigma = sigma  * log(10);
phi   = phi    * log(10);
tau   = tau    * log(10);

% PGV from cm/s to m/s
if To==-1
    lny  = lny - log(100);
end

% unit conversion, cm/s2 to g
if To>0
    lny  = lny - log(980.066);
end



function [lny,sigma,phi,tau] = gmpe(index,Mw,Rjb,media,mechanism,SATYPE)
switch lower(SATYPE)
    case 'geoh' ,[e1,c1,c2,h,c3,b1,b2,sA,sB,sC,sD,sE,f1,f2,f3,f4,sigma,phi,tau] = getcoeffs_SAH(index);
    case 'z'    ,[e1,c1,c2,h,c3,b1,b2,sA,sB,sC,sD,sE,f1,f2,f3,f4,sigma,phi,tau] = getcoeffs_SAZ(index);
end
Fd  = (c1 + c2.*(Mw-5)).*log10(sqrt(Rjb.^2+h^2)/1) - c3.*(sqrt(Rjb.^2+h^2)-1);
Fm  = b1.*(Mw-6.75) + b2.*(Mw-6.75).^2; % this is because b3=0. See page 6, Bindi 2011

C1=0;C2=0;C3=0;C4=0;C5=0;
switch media
    case 'AEC8', C1=0;
    case 'BEC8', C2=0;
    case 'CEC8', C3=0;
    case 'DEC8', C4=0;
    case 'EEC8', C5=0;
end
Fs  = sA*C1+sB*C2+sC*C3+sD*C4+sE*C5;

E1=0;E2=0;E3=0;E4=0;
switch mechanism
    case 'normal',      E1=1;
    case 'reverse',     E2=0;
    case 'strike-slip', E3=0;
    case 'unknown',     E4=0;
end
Fsof  = f1*E1+f2*E2+f3*E3+f4*E4;
lny   = e1 + Fd + Fm + Fs + Fsof;

function [e1,c1,c2,h,c3,b1,b2,sA,sB,sC,sD,sE,f1,f2,f3,f4,sigma,phi,tau] = getcoeffs_SAH(index)
COEFF=[
    2.30500 -1.51700 0.32600 7.87900  0.00000 0.23600  -0.00686 0.00000 0.20500 0.26900 0.32100 0.42800 -0.03080 0.07540 -0.04460 0.00000 0.194 0.270 0.332
    3.67200 -1.94000 0.41300 10.32200 0.00013 -0.26200 -0.07070 0.00000 0.16200 0.24000 0.10500 0.57000 -0.05030 0.10500 -0.05440 0.00000 0.172 0.290 0.337
    3.725000 -1.976000 0.422000 9.445000 0.000270 -0.315000 -0.078700 0.000000 0.161000 0.240000 0.060000 0.614000 -0.044200 0.106000 -0.061500 0.000000 0.154 0.307 0.343
    3.906000 -2.050000 0.446000 9.810000 0.000758 -0.375000 -0.077300 0.000000 0.154000 0.235000 0.057000 0.536000 -0.045400 0.103000 -0.057600 0.000000 0.152 0.324 0.358
    3.796000 -1.794000 0.415000 9.500000 0.002550 -0.290000 -0.065100 0.000000 0.178000 0.247000 0.037000 0.599000 -0.065600 0.111000 -0.045100 0.000000 0.154 0.328 0.363
    3.799000 -1.521000 0.320000 9.163000 0.003720 -0.098700 -0.057400 0.000000 0.174000 0.240000 0.148000 0.740000 -0.075500 0.123000 -0.047700 0.000000 0.179 0.318 0.365
    3.750000 -1.379000 0.280000 8.502000 0.003840 0.009400 -0.051700 0.000000 0.156000 0.234000 0.115000 0.556000 -0.073300 0.106000 -0.032800 0.000000 0.209 0.32 0.382
    3.699000 -1.340000 0.254000 7.912000 0.003260 0.086000 -0.045700 0.000000 0.182000 0.245000 0.154000 0.414000 -0.056800 0.110000 -0.053400 0.000000 0.212 0.308 0.374
    3.753000 -1.414000 0.255000 8.215000 0.002190 0.124000 -0.043500 0.000000 0.201000 0.244000 0.213000 0.301000 -0.056400 0.087700 -0.031300 0.000000 0.218 0.29 0.363
    3.600000 -1.320000 0.253000 7.507000 0.002320 0.154000 -0.043700 0.000000 0.220000 0.257000 0.243000 0.235000 -0.052300 0.090500 -0.038200 0.000000 0.221 0.283 0.359
    3.549000 -1.262000 0.233000 6.760000 0.002190 0.225000 -0.040600 0.000000 0.229000 0.255000 0.226000 0.202000 -0.056500 0.092700 -0.036300 0.000000 0.21 0.279 0.349
    3.550000 -1.261000 0.223000 6.775000 0.001760 0.292000 -0.030600 0.000000 0.226000 0.271000 0.237000 0.181000 -0.059700 0.088600 -0.028900 0.000000 0.204 0.284 0.350
    3.526000 -1.181000 0.184000 5.992000 0.001860 0.384000 -0.025000 0.000000 0.218000 0.280000 0.263000 0.168000 -0.059900 0.085000 -0.025200 0.000000 0.203 0.283 0.349
    3.561000 -1.230000 0.178000 6.382000 0.001140 0.436000 -0.022700 0.000000 0.219000 0.296000 0.355000 0.142000 -0.055900 0.079000 -0.023100 0.000000 0.203 0.283 0.348
    3.485000 -1.172000 0.154000 5.574000 0.000942 0.529000 -0.018500 0.000000 0.210000 0.303000 0.496000 0.134000 -0.046100 0.089600 -0.043500 0.000000 0.212 0.283 0.354
    3.325000 -1.115000 0.163000 4.998000 0.000909 0.545000 -0.021500 0.000000 0.210000 0.304000 0.621000 0.150000 -0.045700 0.079500 -0.033800 0.000000 0.213 0.284 0.355
    3.318000 -1.137000 0.154000 5.231000 0.000483 0.563000 -0.026300 0.000000 0.212000 0.315000 0.680000 0.154000 -0.035100 0.071500 -0.036400 0.000000 0.214 0.286 0.357
    3.264000 -1.114000 0.140000 5.002000 0.000254 0.599000 -0.027000 0.000000 0.221000 0.332000 0.707000 0.152000 -0.029800 0.066000 -0.036200 0.000000 0.222 0.283 0.360
    2.896000 -0.986000 0.173000 4.340000 0.000783 0.579000 -0.033600 0.000000 0.244000 0.365000 0.717000 0.183000 -0.020700 0.061400 -0.040700 0.000000 0.227 0.29 0.368
    2.675000 -0.960000 0.192000 4.117000 0.000802 0.575000 -0.035300 0.000000 0.251000 0.375000 0.667000 0.203000 -0.014000 0.050500 -0.036500 0.000000 0.218 0.303 0.373
    2.584000 -1.006000 0.205000 4.505000 0.000427 0.574000 -0.037100 0.000000 0.252000 0.357000 0.593000 0.220000 0.001540 0.037000 -0.038500 0.000000 0.219 0.305 0.376
    2.537000 -1.009000 0.193000 4.373000 0.000164 0.597000 -0.036700 0.000000 0.245000 0.352000 0.540000 0.226000 0.005120 0.035000 -0.040100 0.000000 0.211 0.308 0.373];
e1      = COEFF(index,1);
c1      = COEFF(index,2);
c2      = COEFF(index,3);
h       = COEFF(index,4);
c3      = COEFF(index,5);
b1      = COEFF(index,6);
b2      = COEFF(index,7);
sA      = COEFF(index,8);
sB      = COEFF(index,9);
sC      = COEFF(index,10);
sD      = COEFF(index,11);
sE      = COEFF(index,12);
f1      = COEFF(index,13);
f2      = COEFF(index,14);
f3      = COEFF(index,15);
f4      = COEFF(index,16);
tau     = COEFF(index,17);
phi     = COEFF(index,18);
sigma   = COEFF(index,19);

function [e1,c1,c2,h,c3,b1,b2,sA,sB,sC,sD,sE,f1,f2,f3,f4,sigma,phi,tau] = getcoeffs_SAZ(index)
COEFF=[
    2.09900 -1.55200 0.37100 9.62900  0.00000 0.22800  0.00756  0.00000 0.15600 0.21100 0.31600 0.23300 -0.04400 0.08490 -0.04090 0.00000 0.190 0.242 0.308
    3.51100 -1.74100 0.32400 9.05200  0.00128 0.00904  -0.02700 0.00000 0.16700 0.20400 0.19000 0.35000 -0.07090 0.07790 -0.00696 0.00000 0.160 0.270 0.314 %PGA_Z
    3.823000 -1.892000 0.301000 7.754000 0.000785 0.013800 -0.029900 0.000000 0.179000 0.228000 0.133000 0.428000 -0.058800 0.072700 -0.013900 0 0.140 0.299 0.330
    3.936000 -1.818000 0.305000 8.385000 0.002290 -0.002600 -0.026700 0.000000 0.168000 0.231000 0.162000 0.318000 -0.097000 0.095000 0.002030 0 0.152 0.304 0.340
    3.801000 -1.579000 0.275000 8.946000 0.003680 0.043400 -0.026000 0.000000 0.190000 0.181000 0.178000 0.342000 -0.090900 0.083600 0.007300 0 0.157 0.296 0.335
    3.684000 -1.348000 0.210000 8.742000 0.004390 0.154000 -0.030500 0.000000 0.204000 0.191000 0.288000 0.407000 -0.075200 0.091700 -0.016500 0 0.177 0.284 0.335
    3.703000 -1.493000 0.258000 10.140000 0.003180 0.059900 -0.044500 0.000000 0.205000 0.191000 0.278000 0.319000 -0.079300 0.099700 -0.020500 0 0.182 0.277 0.332
    3.624000 -1.439000 0.248000 9.825000 0.002770 0.126000 -0.035400 0.000000 0.193000 0.172000 0.344000 0.245000 -0.073500 0.096500 -0.023000 0 0.193 0.269 0.331
    3.519000 -1.352000 0.239000 8.936000 0.002740 0.187000 -0.033100 0.000000 0.170000 0.179000 0.356000 0.163000 -0.078600 0.070200 8.410000 0 0.000 0.198 0.265
    3.317000 -1.185000 0.211000 7.700000 0.003180 0.234000 -0.035300 0.000000 0.157000 0.191000 0.372000 0.167000 -0.079000 0.077600 1.410000 0 0.000 0.194 0.258
    3.161000 -1.199000 0.264000 7.697000 0.002880 0.165000 -0.042800 0.000000 0.149000 0.182000 0.457000 0.132000 -0.075700 0.091200 -0.015500 0 0.205 0.262 0.333
    3.280000 -1.287000 0.246000 8.131000 0.001780 0.212000 -0.042600 0.000000 0.147000 0.200000 0.459000 0.105000 -0.077800 0.083100 -0.005320 0 0.217 0.266 0.343
    3.358000 -1.311000 0.221000 8.182000 0.001240 0.293000 -0.033100 0.000000 0.148000 0.194000 0.486000 0.098000 -0.069100 0.082900 -0.013800 0 0.214 0.262 0.338
    3.347000 -1.302000 0.223000 8.409000 0.001080 0.380000 -0.016500 0.000000 0.150000 0.197000 0.512000 0.082000 -0.057500 0.080800 -0.023400 0 0.230 0.259 0.347
    3.072000 -1.168000 0.222000 6.960000 0.001180 0.395000 -0.025800 0.000000 0.157000 0.213000 0.518000 0.099000 -0.037300 0.085600 -0.048300 0 0.239 0.270 0.361
    2.941000 -1.124000 0.222000 6.679000 0.001140 0.414000 -0.030100 0.000000 0.170000 0.219000 0.513000 0.108000 -0.025100 0.069400 -0.044400 0 0.241 0.271 0.363
    2.795000 -1.031000 0.218000 5.763000 0.001510 0.430000 -0.034800 0.000000 0.182000 0.217000 0.494000 0.096000 -0.017200 0.069000 -0.051800 0 0.248 0.269 0.366
    2.709000 -0.952000 0.202000 4.806000 0.001630 0.507000 -0.024400 0.000000 0.177000 0.229000 0.456000 0.092000 -0.010600 0.068000 -0.057300 0 0.248 0.269 0.365
    2.536000 -0.854000 0.194000 4.433000 0.001910 0.604000 -0.013000 0.000000 0.179000 0.253000 0.407000 0.115000 -0.004800 0.069500 -0.064700 0 0.245 0.277 0.370
    2.523000 -0.808000 0.147000 4.439000 0.002180 0.743000 -0.002080 0.000000 0.148000 0.262000 0.392000 0.130000 0.005870 0.053000 -0.058900 0 0.247 0.291 0.382
    2.292000 -0.684000 0.142000 2.995000 0.002630 0.795000 0.007000 0.000000 0.134000 0.259000 0.346000 0.117000 0.001260 0.049800 -0.051100 0 0.243 0.298 0.384
    2.126000 -0.645000 0.150000 2.219000 0.002830 0.754000 -0.004880 0.000000 0.148000 0.256000 0.297000 0.117000 0.004100 0.049000 -0.053100 0 0.237 0.302 0.384];
e1      = COEFF(index,1);
c1      = COEFF(index,2);
c2      = COEFF(index,3);
h       = COEFF(index,4);
c3      = COEFF(index,5);
b1      = COEFF(index,6);
b2      = COEFF(index,7);
sA      = COEFF(index,8);
sB      = COEFF(index,9);
sC      = COEFF(index,10);
sD      = COEFF(index,11);
sE      = COEFF(index,12);
f1      = COEFF(index,13);
f2      = COEFF(index,14);
f3      = COEFF(index,15);
f4      = COEFF(index,16);
tau  = COEFF(index,17);
phi  = COEFF(index,18);
sigma   = COEFF(index,19);
